<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - AACEM Coaching</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0d6efd;
      --secondary: #6c757d;
      --success: #198754;
      --warning: #ffc107;
      --danger: #dc3545;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }

    /* Navbar */
    .navbar {
      background-color: rgb(45, 107, 107) !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1030;
    }

    .navbar .navbar-brand i {
      color: #00b4d8;
    }

    /* Sidebar */
    .dashboard-sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      width: 250px;
      height: calc(100vh - 56px);
      background: linear-gradient(135deg, #2c3e50, #34495e);
      padding: 20px 0;
      overflow-y: auto;
    }

    .dashboard-sidebar h4 {
      color: #ecf0f1;
      padding: 0 20px;
      margin-bottom: 20px;
    }

    .dashboard-sidebar .nav-link {
      color: #bdc3c7;
      padding: 12px 20px;
      margin: 5px 0;
      border-radius: 0;
      border-left: 4px solid transparent;
      transition: all 0.3s ease;
    }

    .dashboard-sidebar .nav-link i {
      width: 20px;
      margin-right: 10px;
      color: #3498db;
    }

    .dashboard-sidebar .nav-link:hover,
    .dashboard-sidebar .nav-link.active {
      background: rgba(52, 152, 219, 0.1);
      color: #ecf0f1;
      border-left-color: #3498db;
    }

    /* Main Content */
    .dashboard-content {
      margin-left: 250px;
      padding: 30px;
      min-height: calc(100vh - 56px);
    }

    /* Cards */
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: none;
      margin-bottom: 25px;
    }

    .card h4 {
      color: #2c3e50;
      margin-bottom: 20px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    /* Tables */
    .table {
      border-radius: 10px;
      overflow: hidden;
    }

    .table th {
      background: #3498db;
      color: white;
      border: none;
    }

    /* Buttons */
    .btn {
      border-radius: 8px;
      font-weight: 500;
    }

    /* Stats Cards */
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .stats-card .number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stats-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* Loading States */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    /* Forms */
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px 15px;
    }

    .form-control:focus, .form-select:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }

    /* Attendance Checkbox */
    .attendance-check {
      transform: scale(1.2);
      margin-right: 8px;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .dashboard-sidebar {
        position: relative;
        width: 100%;
        height: auto;
        top: 0;
      }

      .dashboard-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <i class="fas fa-graduation-cap me-2"></i>AACEM Institute
    </a>
    <div>
      <span class="text-white me-3" id="welcomeText">Welcome, Teacher</span>
      <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<!-- Sidebar -->
<div class="dashboard-sidebar">
  <div class="text-center mb-4">
    <h4><i class="fas fa-chalkboard-teacher me-2"></i>Teacher Panel</h4>
  </div>
  <a class="nav-link active" href="#profile"><i class="fas fa-user"></i> Profile</a>
  <a class="nav-link" href="#classes"><i class="fas fa-book"></i> My Classes</a>
  <a class="nav-link" href="#attendance"><i class="fas fa-clipboard-list"></i> Attendance</a>
  <a class="nav-link" href="#assignments"><i class="fas fa-file-alt"></i> Assignments</a>
  <a class="nav-link" href="#results"><i class="fas fa-chart-bar"></i> Results</a>
  <a class="nav-link" href="#notices"><i class="fas fa-bullhorn"></i> Notices</a>
</div>

<!-- Main Content -->
<div class="dashboard-content">

  <!-- Profile Section -->
  <section id="profile" class="mb-4">
    <div class="card p-4">
      <h4><i class="fas fa-user me-2"></i>My Profile</h4>
      <div id="profileContent" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading profile data...</p>
      </div>
    </div>
  </section>

  <!-- Classes Section -->
  <section id="classes" class="mb-4">
    <div class="card p-4">
      <h4><i class="fas fa-book me-2"></i>My Classes</h4>
      <div id="classesContent" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading class data...</p>
      </div>
    </div>
  </section>

  <!-- Attendance Section -->
  <section id="attendance" class="mb-4">
    <div class="card p-4">
      <h4><i class="fas fa-clipboard-list me-2"></i>Attendance Management</h4>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Select Course:</label>
          <select class="form-select" id="attendanceCourse">
            <option value="">Loading courses...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Date:</label>
          <input type="date" class="form-control" id="attendanceDate" value="<?php echo date('Y-m-d'); ?>">
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary w-100" onclick="loadStudentsForAttendance()">
            <i class="fas fa-sync me-2"></i>Load Students
          </button>
        </div>
      </div>
      <div id="attendanceContent" class="loading">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          Please select a course and date to mark attendance
        </div>
      </div>
    </div>
  </section>

  <!-- Assignments Section -->
  <section id="assignments" class="mb-4">
    <div class="card p-4">
      <h4><i class="fas fa-file-alt me-2"></i>Assignment Management</h4>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Course:</label>
          <select class="form-select" id="assignmentCourse">
            <option value="">Loading courses...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Assignment Title:</label>
          <input type="text" class="form-control" id="assignmentTitle" placeholder="Enter assignment title">
        </div>
        <div class="col-md-4">
          <label class="form-label">Due Date:</label>
          <input type="date" class="form-control" id="assignmentDueDate">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Description:</label>
        <textarea class="form-control" id="assignmentDescription" rows="3" placeholder="Enter assignment description"></textarea>
      </div>
      <button class="btn btn-success" onclick="createAssignment()">
        <i class="fas fa-plus me-2"></i>Create Assignment
      </button>
      
      <hr class="my-4">
      
      <h5>Existing Assignments</h5>
      <div id="assignmentsList" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading assignments...</p>
      </div>
    </div>
  </section>

  <!-- Results Section -->
  <section id="results" class="mb-4">
    <div class="card p-4">
      <h4><i class="fas fa-chart-bar me-2"></i>Results Management</h4>
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Course:</label>
          <select class="form-select" id="resultsCourse">
            <option value="">Loading courses...</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Exam Type:</label>
          <select class="form-select" id="examType">
            <option value="midterm">Mid Term</option>
            <option value="final">Final</option>
            <option value="quiz">Quiz</option>
            <option value="assignment">Assignment</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Subject:</label>
          <input type="text" class="form-control" id="subjectName" placeholder="Enter subject">
        </div>
        <div class="col-md-3">
          <label class="form-label">Total Marks:</label>
          <input type="number" class="form-control" id="totalMarks" value="100">
        </div>
      </div>
      <div id="resultsContent" class="loading">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          Please select a course to enter marks
        </div>
      </div>
    </div>
  </section>

  <!-- Notices Section -->
  <section id="notices" class="mb-4">
    <div class="card p-4">
      <h4><i class="fas fa-bullhorn me-2"></i>Notice Management</h4>
      <div class="mb-3">
        <label class="form-label">Notice Title:</label>
        <input type="text" class="form-control" id="noticeTitle" placeholder="Enter notice title">
      </div>
      <div class="mb-3">
        <label class="form-label">Notice Message:</label>
        <textarea class="form-control" id="noticeMessage" rows="4" placeholder="Write your notice here..."></textarea>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Audience:</label>
          <select class="form-select" id="noticeAudience">
            <option value="all">All Students</option>
            <option value="teachers">Teachers Only</option>
            <option value="specific">Specific Course</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Priority:</label>
          <select class="form-select" id="noticePriority">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-warning w-100" onclick="publishNotice()">
            <i class="fas fa-paper-plane me-2"></i>Publish Notice
          </button>
        </div>
      </div>
      
      <hr class="my-4">
      
      <h5>Recent Notices</h5>
      <div id="noticesList" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading notices...</p>
      </div>
    </div>
  </section>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // API Configuration
  const API_BASE_URL = 'http://localhost:5000/api';
  
  // Teacher data (in real app, this would come from login)
  const TEACHER_ID = 'TCH001'; // Default teacher ID

  // Main function to load all data
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Loading teacher dashboard data...');
    loadTeacherData();
  });

  // Load all teacher data
  async function loadTeacherData() {
    try {
      await Promise.all([
        loadProfile(),
        loadCourses(),
        loadAssignments(),
        loadNotices()
      ]);
      console.log('All teacher data loaded successfully');
    } catch (error) {
      console.error('Error loading teacher data:', error);
      showError('Failed to load data. Please refresh the page.');
    }
  }

  // Load Teacher Profile
  async function loadProfile() {
    try {
      const response = await fetch(`${API_BASE_URL}/teacher-profile/${TEACHER_ID}`);
      const result = await response.json();
      
      if (result.success && result.teacher) {
        const teacher = result.teacher;
        
        document.getElementById('welcomeText').textContent = `Welcome, ${teacher.name}`;
        
        document.getElementById('profileContent').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>Name:</strong> ${teacher.name}</p>
              <p><strong>Teacher ID:</strong> ${teacher.teacher_id}</p>
              <p><strong>Subject:</strong> ${teacher.subject}</p>
              <p><strong>Qualification:</strong> ${teacher.qualification || 'N/A'}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Experience:</strong> ${teacher.experience || 'N/A'} years</p>
              <p><strong>Phone:</strong> ${teacher.phone}</p>
              <p><strong>Email:</strong> ${teacher.email || 'N/A'}</p>
              <p><strong>Joining Date:</strong> ${teacher.joining_date}</p>
            </div>
          </div>
          ${teacher.address ? `<div class="mt-3"><strong>Address:</strong><br>${teacher.address}</div>` : ''}
        `;
      } else {
        document.getElementById('profileContent').innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Profile data not available
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading profile:', error);
      document.getElementById('profileContent').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          Failed to load profile data
        </div>
      `;
    }
  }

  // Load Courses for Dropdowns
  async function loadCourses() {
    try {
      const response = await fetch(`${API_BASE_URL}/courses`);
      const result = await response.json();
      
      if (result.success && result.courses) {
        const courses = result.courses.filter(course => course.is_active);
        
        // Populate all course dropdowns
        const dropdowns = ['attendanceCourse', 'assignmentCourse', 'resultsCourse'];
        dropdowns.forEach(dropdownId => {
          const dropdown = document.getElementById(dropdownId);
          dropdown.innerHTML = '<option value="">Select Course</option>';
          courses.forEach(course => {
            dropdown.innerHTML += `<option value="${course.course_code}">${course.course_name} (${course.course_code})</option>`;
          });
        });

        // Display classes in classes section
        document.getElementById('classesContent').innerHTML = `
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <th>Course Code</th>
                  <th>Course Name</th>
                  <th>Duration</th>
                  <th>Fee</th>
                  <th>Students</th>
                </tr>
              </thead>
              <tbody>
                ${courses.map(course => `
                  <tr>
                    <td>${course.course_code}</td>
                    <td>${course.course_name}</td>
                    <td>${course.duration} months</td>
                    <td>₹${parseFloat(course.fee_amount).toLocaleString('en-IN')}</td>
                    <td><span class="badge bg-primary">${course.student_count || 0}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading courses:', error);
    }
  }

  // Load Students for Attendance
  async function loadStudentsForAttendance() {
    const course = document.getElementById('attendanceCourse').value;
    const date = document.getElementById('attendanceDate').value;
    
    if (!course || !date) {
      alert('Please select both course and date');
      return;
    }

    try {
      document.getElementById('attendanceContent').innerHTML = `
        <div class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading students...</p>
        </div>
      `;

      const response = await fetch(`${API_BASE_URL}/course-students/${course}`);
      const result = await response.json();

      if (result.success && result.students) {
        let tableHTML = `
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Student ID</th>
                  <th>Name</th>
                  <th>Attendance</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        result.students.forEach(student => {
          tableHTML += `
            <tr>
              <td>${student.student_id}</td>
              <td>${student.name}</td>
              <td>
                <div class="form-check form-check-inline">
                  <input class="form-check-input attendance-check" type="radio" name="attendance_${student.student_id}" id="present_${student.student_id}" value="present" checked>
                  <label class="form-check-label" for="present_${student.student_id}">Present</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input attendance-check" type="radio" name="attendance_${student.student_id}" id="absent_${student.student_id}" value="absent">
                  <label class="form-check-label" for="absent_${student.student_id}">Absent</label>
                </div>
              </td>
            </tr>
          `;
        });

        tableHTML += `
              </tbody>
            </table>
          </div>
          <button class="btn btn-success mt-3" onclick="saveAttendance('${course}', '${date}')">
            <i class="fas fa-save me-2"></i>Save Attendance
          </button>
        `;

        document.getElementById('attendanceContent').innerHTML = tableHTML;
      }
    } catch (error) {
      console.error('Error loading students:', error);
      document.getElementById('attendanceContent').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          Failed to load students
        </div>
      `;
    }
  }

  // Save Attendance
  async function saveAttendance(course, date) {
    const attendanceData = {};
    const students = document.querySelectorAll('input[type="radio"]:checked');
    
    students.forEach(radio => {
      const studentId = radio.name.replace('attendance_', '');
      attendanceData[studentId] = radio.value;
    });

    try {
      const response = await fetch(`${API_BASE_URL}/mark-attendance`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date: date,
          class: course,
          attendance: attendanceData
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('Attendance saved successfully!');
      } else {
        alert('Error saving attendance: ' + result.message);
      }
    } catch (error) {
      console.error('Error saving attendance:', error);
      alert('Failed to save attendance');
    }
  }

  // Create Assignment
  async function createAssignment() {
    const course = document.getElementById('assignmentCourse').value;
    const title = document.getElementById('assignmentTitle').value;
    const dueDate = document.getElementById('assignmentDueDate').value;
    const description = document.getElementById('assignmentDescription').value;

    if (!course || !title || !dueDate) {
      alert('Please fill all required fields');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/create-assignment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          course_code: course,
          title: title,
          description: description,
          due_date: dueDate,
          teacher_id: TEACHER_ID
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('Assignment created successfully!');
        document.getElementById('assignmentTitle').value = '';
        document.getElementById('assignmentDueDate').value = '';
        document.getElementById('assignmentDescription').value = '';
        loadAssignments();
      } else {
        alert('Error creating assignment: ' + result.message);
      }
    } catch (error) {
      console.error('Error creating assignment:', error);
      alert('Failed to create assignment');
    }
  }

  // Load Assignments
  async function loadAssignments() {
    try {
      const response = await fetch(`${API_BASE_URL}/teacher-assignments/${TEACHER_ID}`);
      const result = await response.json();

      if (result.success && result.assignments) {
        let assignmentsHTML = '<div class="list-group">';
        
        result.assignments.forEach(assignment => {
          assignmentsHTML += `
            <div class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${assignment.title}</h6>
                <small>Due: ${new Date(assignment.due_date).toLocaleDateString()}</small>
              </div>
              <p class="mb-1">${assignment.description}</p>
              <small>Course: ${assignment.course_code} | Created: ${new Date(assignment.created_at).toLocaleDateString()}</small>
            </div>
          `;
        });

        assignmentsHTML += '</div>';
        document.getElementById('assignmentsList').innerHTML = assignmentsHTML;
      } else {
        document.getElementById('assignmentsList').innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No assignments created yet
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading assignments:', error);
      document.getElementById('assignmentsList').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          Failed to load assignments
        </div>
      `;
    }
  }

  // Publish Notice
  async function publishNotice() {
    const title = document.getElementById('noticeTitle').value;
    const message = document.getElementById('noticeMessage').value;
    const audience = document.getElementById('noticeAudience').value;
    const priority = document.getElementById('noticePriority').value;

    if (!title || !message) {
      alert('Please fill title and message');
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/send-notification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title,
          message: message,
          audience: audience,
          priority: priority
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('Notice published successfully!');
        document.getElementById('noticeTitle').value = '';
        document.getElementById('noticeMessage').value = '';
        loadNotices();
      } else {
        alert('Error publishing notice: ' + result.message);
      }
    } catch (error) {
      console.error('Error publishing notice:', error);
      alert('Failed to publish notice');
    }
  }

  // Load Notices
  async function loadNotices() {
    try {
      const response = await fetch(`${API_BASE_URL}/notifications`);
      const result = await response.json();

      if (result.success && result.notifications) {
        let noticesHTML = '<div class="list-group">';
        
        result.notifications.forEach(notice => {
          noticesHTML += `
            <div class="list-group-item">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${notice.title}</h6>
                <small class="text-muted">${new Date(notice.created_at).toLocaleDateString()}</small>
              </div>
              <p class="mb-1">${notice.message}</p>
              <small>Audience: ${notice.audience} | Priority: <span class="badge bg-${notice.priority === 'high' ? 'danger' : notice.priority === 'medium' ? 'warning' : 'info'}">${notice.priority}</span></small>
            </div>
          `;
        });

        noticesHTML += '</div>';
        document.getElementById('noticesList').innerHTML = noticesHTML;
      } else {
        document.getElementById('noticesList').innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No notices available
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading notices:', error);
      document.getElementById('noticesList').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          Failed to load notices
        </div>
      `;
    }
  }

  // Show error message
  function showError(message) {
    alert('Error: ' + message);
  }

  // Logout function
  function logout() {
    const confirmLogout = confirm("Are you sure you want to log out?");
    if (confirmLogout) {
      alert("You have been logged out!");
      window.location.href = "index.html";
    }
  }

</script>
</body>
</html>